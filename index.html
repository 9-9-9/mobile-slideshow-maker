<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<link rel="stylesheet" href="icongrid/icongrid.css">
<style>
#grid {
  width: 300px;
  height: 300px;
  border: 1px solid black;
}
</style>
<title>Hello</title>
<div id="grid"></div>
<form>
  <input type="file" id="input-file">
  <button type="submit" style="display: none">Add Picture</button>
</form>
<button id="export">Publish to Thimble</button>
<button id="wipe">Reset this App</button>
<script src="vendor/IndexedDBShim.min.js"></script>
<script src="vendor/jquery.min.js"></script>
<script src="vendor/spin.min.js"></script>
<script src="vendor/exif.js"></script>
<script src="icongrid/base32.js"></script>
<script src="icongrid/icongrid.js"></script>
<script src="data-uri-store.js"></script>
<script src="utils.js"></script>
<script src="model.js"></script>
<script src="publish.js"></script>
<script>
var NAME = "msm";
var IMG_PUB_URL = "http://thimble-mobile-concept-img-uploader.toolness.org";
var IMG_PUB_PASSKEY = "thimbley";

var spinner = new Spinner();
var model;
var grid;

$("#export").click(function() {
  publishImages({
    model: model,
    baseURL: IMG_PUB_URL,
    passkey: IMG_PUB_PASSKEY,
    onerror: function(msg, err) {
      alert(msg);
    },
    onprogress: function(percentDone) {
      console.log("PROGRESS", percentDone);
    },
    oncomplete: function() {
      console.log("ALL DONE");
    }
  });
});

$("#wipe").click(function() {
  spinner.spin(document.body);
  model.done();
  MSM_Model.wipe(NAME, function(err) {
    spinner.stop();
    if (err)
      return alert("ERROR " + err);
    delete window.localStorage[NAME + "_grid"];
    window.location.reload();
  });
});

$("#input-file").change(function() {
  $("form").submit();
});

$("form").submit(function() {
  var files = $("#input-file")[0].files;
  var remaining = files.length;
  
  if (remaining) spinner.spin(document.body);
  
  [].slice.call(files).forEach(function(file) {
    model.addImage(file, function(err, id) {
      if (--remaining == 0) spinner.stop();
      if (err)
        return alert("ERROR " + err);
      var metadata = model.getMetadata()[id];
      grid.addItemToGrid(id.toString(), metadata);
    });
  });

  return false;
});

function initUI() {
  var dataSource = {
    getItemList: function(callback) {
      callback(model.getMetadata());
    },
    openItem: function(itemID) {},
    userRemovedItem: function(itemID, callback) {
      alert("removing items is not yet supported");
    },
    getItemTitle: function(itemID) {
      return "Pic " + itemID;
    }
  };
  var gridDiv = $("#grid");
  var layout = new GridLayout(gridDiv.width(), gridDiv.height(), 3, 3);
  
  grid = new IconGrid(NAME + "_grid", gridDiv, dataSource, layout);
  
  grid.initialize();
  grid.refresh();
  
  //var state = grid.loadIconGridState(grid.dashname);
  //console.log(state);
  //window.grid = grid;
}

$(window).ready(function() {
  spinner.spin(document.body);
  
  model = new MSM_Model({
    name: NAME,
    onready: function() {
      spinner.stop();
      initUI();
    },
    onerror: function(name, e) {
      alert("ERROR " + name);
    }
  });
});
</script>
