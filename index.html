<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<link rel="stylesheet" href="icongrid/icongrid.css">
<style>
#grid {
  width: 300px;
  height: 300px;
  border: 1px solid black;
}
</style>
<title>Hello</title>
<div id="grid"></div>
<form>
  <input type="file" id="input-file">
  <button type="submit" style="display: none">Add Picture</button>
</form>
<button id="export">Export to Thimble</button>
<button id="wipe">Reset this App</button>
<script src="vendor/IndexedDBShim.min.js"></script>
<script src="vendor/jquery.min.js"></script>
<script src="vendor/spin.min.js"></script>
<script src="vendor/exif.js"></script>
<script src="icongrid/base32.js"></script>
<script src="icongrid/icongrid.js"></script>
<script src="data-uri-store.js"></script>
<script src="utils.js"></script>
<script src="model.js"></script>
<script>
var NAME = "msm";
var IMG_PUB_URL = "http://thimble-mobile-concept-img-uploader.toolness.org";
var IMG_PUB_PASSKEY = "thimbley";

var spinner = new Spinner();
var model;
var grid;

function publishOneImage(file, progressCb, cb) {
  var req = new XMLHttpRequest();
  var url = IMG_PUB_URL + '/upload?cacheBust=' + Date.now();
  var passkey = IMG_PUB_PASSKEY;
  req.onload = function() {
    if (req.status == 403) {
      console.log('bad passkey');
      cb(null);
    } else if (req.status == 200) {
      var entry = JSON.parse(req.responseText);
      entry.type = file.type;
      cb(entry);
    } else {
      cb(null);
    }
  };
  req.onerror = function() {
    cb(null);
  };
  if (req.upload) {
    req.upload.addEventListener("progress", function(evt) {
      if (evt.lengthComputable)
        progressCb(evt.loaded / evt.total);
    }, false);
  }
  req.open('POST', url);
  req.setRequestHeader('X-Creation-Key', passkey);
  req.setRequestHeader('Content-Type', file.type);
  req.send(file);
}

function publishImages(options) {
  var onerror = options.onerror;
  var onprogress = options.onprogress;
  var oncomplete = options.oncomplete;
  var images = model.getMetadata();
  var imageIDs = Object.keys(images);
  var imageCount = imageIDs.length;
  var progressPerImage = 1 / imageCount;
  var toPublish = imageIDs.map(function(id) { return images[id] });
  
  function uploadNextImage() {
    if (!toPublish.length)
      return oncomplete();
    
    var baseProgress = (imageCount - toPublish.length) / imageCount;
    var metadata = toPublish.pop();
    var id = metadata.id;
    
    if (metadata.publishedURL) {
      onprogress(baseProgress + progressPerImage);
      return setTimeout(uploadNextImage, 100);
    }
    
    model.getImage(id, function(err, file) {
      if (err)
        onerror("Failed to upload picture " + id, err);
      if (!file)
        onerror("Picture " + id + " not in store");
      
      publishOneImage(file, function(percentDone) {
        onprogress(baseProgress + progressPerImage * percentDone);
      }, function(entry) {
        var images = model.getMetadata();
        images[id].publishedURL = entry.url;
        images[id].publishedRevocationKey = entry.revocationKey;
        model.setMetadata(images);
        uploadNextImage();
      });
    });
  }
  
  uploadNextImage();
}

$("#export").click(function() {
  publishImages({
    onerror: function(msg, err) {
      alert(msg);
    },
    onprogress: function(percentDone) {
      console.log("PROGRESS", percentDone);
    },
    oncomplete: function() {
      console.log("ALL DONE");
    }
  });
});

$("#wipe").click(function() {
  spinner.spin(document.body);
  model.done();
  MSM_Model.wipe(NAME, function(err) {
    spinner.stop();
    if (err)
      return alert("ERROR " + err);
    delete window.localStorage[NAME + "_grid"];
    window.location.reload();
  });
});

$("#input-file").change(function() {
  $("form").submit();
});

$("form").submit(function() {
  var files = $("#input-file")[0].files;
  var remaining = files.length;
  
  if (remaining) spinner.spin(document.body);
  
  [].slice.call(files).forEach(function(file) {
    model.addImage(file, function(err, id) {
      if (--remaining == 0) spinner.stop();
      if (err)
        return alert("ERROR " + err);
      var metadata = model.getMetadata()[id];
      grid.addItemToGrid(id.toString(), metadata);
    });
  });

  return false;
});

function initUI() {
  var dataSource = {
    getItemList: function(callback) {
      callback(model.getMetadata());
    },
    openItem: function(itemID) {
      
    },
    userRemovedItem: function(itemID, callback) {
      
    },
    getItemTitle: function(itemID) {
      return "Pic " + itemID;
    }
  };
  var gridDiv = $("#grid");
  var layout = new GridLayout(gridDiv.width(), gridDiv.height(), 3, 3);
  
  grid = new IconGrid(NAME + "_grid", gridDiv, dataSource, layout);
  
  grid.initialize();
  grid.refresh();
  
  //var state = grid.loadIconGridState(grid.dashname);
  //console.log(state);
  //window.grid = grid;
}

$(window).ready(function() {
  spinner.spin(document.body);
  
  model = new MSM_Model({
    name: NAME,
    onready: function() {
      spinner.stop();
      initUI();
    },
    onerror: function(name, e) {
      alert("ERROR " + name);
    }
  });
});
</script>
